<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>OXO Scheduler</title>
  <style>
    body {
      margin: 0;
      background: black;
    }
    video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
    #debug {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      z-index: 9999;
    }
    #countdown {
      position: absolute;
      top: 10px;
      right: 10px;
      color: yellow;
      font-size: 2em;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <video id="player" autoplay muted playsinline></video>
  <div id="countdown" style="display: none;"></div>
  <div id="debug"></div>

  <script>
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const folder = isMobile ? "Mobile" : "TV";
    const GitHubBase = `https://nik978.github.io/OXO-Video-test/${folder}/`;

    const videoMap = {
      "Bucket": GitHubBase + "Bucket.mp4",
      "Cosplay": GitHubBase + "Cosplay.mp4",
      "Football": GitHubBase + "Football.mp4",
      "Happy": GitHubBase + "Happy.mp4",
      "Intro": GitHubBase + "Intro.mp4",
      "Recruit": GitHubBase + "Recruit.mp4",
    };

    const playlistMap = {
      "Sun": {
        pre: ["Happy", "Football", "Happy", "Bucket"],
        post: ["Intro", "Football", "Bucket", "Happy", "Football", "Cosplay", "Football", "Recruit"]
      },
      "Mon": {
        pre: ["Happy", "Football", "Happy", "Bucket"],
        post: ["Intro", "Football", "Bucket", "Happy", "Football", "Cosplay", "Football", "Recruit"]
      },
      "Tue": {
        pre: ["Happy", "Football", "Happy", "Bucket"],
        post: ["Intro", "Football", "Bucket", "Happy", "Football", "Cosplay", "Football", "Recruit"]
      },
      "Wed": {
        pre: ["Happy", "Football", "Happy", "Bucket"],
        post: ["Intro", "Football", "Bucket", "Happy", "Football", "Cosplay", "Football", "Recruit"]
      },
      "Thu": {
        pre: ["Bucket", "Football", "Bucket", "Happy", "Bucket"],
        post: ["Intro", "Bucket", "Football", "Bucket", "Happy", "Bucket", "Cosplay", "Bucket", "Recruit"]
      },
      "Fri": {
        pre: ["Happy", "Football", "Happy", "Bucket"],
        post: ["Intro", "Football", "Bucket", "Happy", "Football", "Cosplay", "Football", "Recruit"]
      },
      "Sat": {
        pre: ["Happy", "Football", "Happy", "Football"],
        post: [] // gestito in getPlaylist()
      }
    };

    const video = document.getElementById("player");
    const debug = document.getElementById("debug");
    const countdownBox = document.getElementById("countdown");

    function getPlaylist() {
      const now = new Date();
      const day = now.toString().slice(0, 3);
      const hour = now.getHours();
      const min = now.getMinutes();
      const totalMin = hour * 60 + min;

      // Giorno commerciale: parte alle 11:00am
      const commercialHour = (totalMin < 660) ? new Date(now.getTime() - 86400000).getDay() : now.getDay();
      const commercialDay = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][commercialHour];

      // Fascia 1: 11:00–17:30 (660–1050) — opzionale
      // Fascia 2: 18:30–21:00 (1110–1260)
      // Fascia 3: 21:00–02:00 (1260–120)
      // Fascia 4: 02:00–04:00 (120–240)
      
      if (commercialDay === "Sat") {
        if (totalMin >= 1260 || totalMin < 120) return ["Football", "Sabato Countdown.mp4"];
        if (totalMin >= 120 && totalMin < 240) return ["Football"];
      }

      if (totalMin >= 1110 && totalMin < 1260) {
        return playlistMap[commercialDay].pre;
      } else {
        return playlistMap[commercialDay].post;
      }
    }

    function updateDebug(fascia, name) {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      const d = now.getDay();
      debug.innerHTML = `
🕒 Time: ${h}:${m}:${s}<br>
📆 Day: ${d} (Sun=0)<br>
🎯 Fascia: ${fascia}<br>
📂 Playlist: ${name}<br>
🖥️ Versione: ${isMobile ? "Mobile" : "TV"}
      `;
    }

    function handleCountdown() {
      const now = new Date();
      const d = now.getDay();
      const totalMin = now.getHours() * 60 + now.getMinutes();
      if (d === 6 && totalMin >= 1260 && totalMin < 1440) {
        countdownBox.style.display = "block";
        setInterval(() => {
          const now = new Date();
          const target = new Date();
          target.setHours(2, 0, 0, 0);
          if (target < now) target.setDate(target.getDate() + 1);
          const diff = target - now;
          if (diff <= 0) {
            countdownBox.innerText = "MATCH INIZIATO!";
            return;
          }
          const h = Math.floor(diff / 3.6e6);
          const m = Math.floor((diff % 3.6e6) / 6e4);
          const s = Math.floor((diff % 6e4) / 1e3);
          countdownBox.innerText = `Match tra ${h}h ${m}m ${s}s`;
        }, 1000);
      }
    }

    let playlist = getPlaylist();
    let current = 0;

    function playNext() {
      const name = playlist[current % playlist.length];
      video.src = videoMap[name] || GitHubBase + name;
      video.play();
      current++;
      const now = new Date();
      const min = now.getHours() * 60 + now.getMinutes();
      const fascia = (min >= 1110 && min < 1260) ? "Fascia 1 (18:30–21:00)" :
                     (min >= 1260 || min < 120) ? "Fascia 2 (21:00–02:00)" :
                     (min >= 120 && min < 240) ? "Fascia 3 (02:00–04:00)" :
                     "Fuori fascia";
      updateDebug(fascia, name);
    }

    video.onended = playNext;
    handleCountdown();
    playNext();
  </script>
</body>
</html>
