<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OXO Scheduler</title>
  <style>
    body { margin: 0; background: black; font-family: monospace; }
    video { width: 100vw; height: 100vh; object-fit: cover; display: none; }
    #logo {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      max-width: 80vw; max-height: 80vh;
      display: none;
    }
    #countdown {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      font-size: 2em;
      font-weight: bold;
      color: yellow;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      display: none;
    }
    #debug {
      position: absolute;
      bottom: 10px; left: 10px;
      font-size: 12px; color: #0f0;
      background: rgba(0, 0, 0, 0.6); padding: 6px;
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<img id="logo" src="TV/logo.png" alt="Logo">
<div id="countdown"></div>
<div id="debug"></div>

<script>
  const video = document.getElementById("video");
  const logo = document.getElementById("logo");
  const countdownBox = document.getElementById("countdown");
  const debug = document.getElementById("debug");
  const logoUrl = "TV/logo.png";
  const versione = "TV";
  let current = 0;
  let playlist = [];
  let countdownTimer = null;

  const schedule = {
    "1": {...},  // Inserisci qui lo schedule completo
    "2": {...},
    "default": {...}
  };

  const videoMap = {};
  const base = "TV/";
  Object.values(schedule).forEach(day => {
    Object.values(day).flat().forEach(name => {
      videoMap[name] = base + name;
    });
  });

  function getDayAndSection() {
    const now = new Date();
    let day = now.getDay();
    if (day === 0) day = 7;
    const h = now.getHours(), m = now.getMinutes();
    const min = h * 60 + m;

    if (min < 300) {
      day -= 1;
      if (day < 1) day = 7;
    }

    let section = "Closed";
    if (min >= 1110 && min < 1260) section = "Happy_Hour";
    else if (min >= 1260 && min < 1320) section = "Standard_1";
    else if (min >= 1320 || min < 120) section = "DJ";
    else if (min >= 120 && min < 300) section = "Standard_2";

    return { day, min, section };
  }

  function updateDebug(day, section, videoName) {
    debug.innerText =
      `üïí Time: ${new Date().toLocaleTimeString()}\n` +
      `üìÖ Day: ${day}\n` +
      `üéØ Section: ${section}\n` +
      `üéûÔ∏è Video: ${videoName || "-"}`;
  }

  function updateCountdown() {
    const now = new Date();
    const target = new Date();
    target.setHours(21, 0, 0, 0);
    if (now > target) target.setDate(target.getDate() + 1);
    const diff = target - now;
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);

    countdownBox.innerText = `‚è≥ ${h}h ${m}m ${s}s`;

    // Fermiamo il countdown quando arriva a zero
    if (diff <= 0) {
      clearInterval(countdownTimer);
      countdownBox.innerText = "MATCH INIZIATO!";
    }
  }

  function isHappyCountdown(min) {
    return min >= 1140 && min < 1260;
  }

  function playNext() {
    const { day, min, section } = getDayAndSection();
    const active = !(section === "Closed");

    if (!active) {
      try { video.pause(); } catch (e) {}
      video.style.display = "none";
      logo.style.display = "block";
      countdownBox.style.display = "none";
      clearInterval(countdownTimer);
      updateDebug(day, section, "-");
      return;
    }

    logo.style.display = "none";
    const daySchedule = schedule[day] || schedule["default"];
    playlist = daySchedule[section] || [];

    if (!playlist || playlist.length === 0) {
      video.style.display = "none";
      updateDebug(day, section, "No video");
      return;
    }

    const name = playlist[current % playlist.length];
    const src = videoMap[name];
    video.src = src;
    video.style.display = "block";

    try {
      video.play();
    } catch (e) {
      console.error("Playback error:", e);
    }

    updateDebug(day, section, name);

    if (name.includes("Happy") && isHappyCountdown(min)) {
      countdownBox.style.display = "block";
      updateCountdown();
      clearInterval(countdownTimer);
      countdownTimer = setInterval(updateCountdown, 1000);
    } else {
      countdownBox.style.display = "none";
      clearInterval(countdownTimer);
    }

    current++;
  }

  video.addEventListener("ended", playNext);
  window.addEventListener("load", playNext);
</script>

</body>
</html>
