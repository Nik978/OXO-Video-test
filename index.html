<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OXO Scheduler - Local Mode</title>
  <style>
    body {
      margin: 0;
      background: black;
    }
    video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
    #logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 60vw;
    }
    #countdown, #debug {
      position: absolute;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-family: monospace;
      font-size: 1.5em;
      padding: 10px;
    }
    #countdown {
      top: 10px;
      right: 10px;
      color: yellow;
    }
    #debug {
      bottom: 10px;
      left: 10px;
      font-size: 0.9em;
      color: #0f0;
    }
  </style>
</head>
<body>
  <video id="player" autoplay muted playsinline></video>
  <img id="logo" src="" style="display:none;" />
  <div id="countdown" style="display:none;"></div>
  <div id="debug"></div>

  <script>
    const videoMap = {
      "Bucket.mp4": "TV/Bucket.mp4",
      "Cosplay.mp4": "TV/Cosplay.mp4",
      "Football.mp4": "TV/Football.mp4",
      "Happy.mp4": "TV/Happy.mp4",
      "Intro.mp4": "TV/Intro.mp4",
      "Recruit.mp4": "TV/Recruit.mp4"
    };

    const logoUrl = "TV/logo.png";

    const schedule = {
      "default": {
        "Standard_1": ["Intro.mp4"],
        "DJ": ["Football.mp4", "Promo.mp4"],
        "Standard_2": ["Recruit.mp4", "Bucket.mp4"]
      },
      "4": {
        "Standard_1": ["Bucket.mp4"],
        "DJ": ["Bucket.mp4", "Football.mp4"],
        "Standard_2": ["Recruit.mp4", "Bucket.mp4"]
      },
      "6": {
        "Standard_1": ["Cosplay.mp4"],
        "DJ": ["Football.mp4", "Cosplay.mp4"],
        "Standard_2": ["Cosplay.mp4", "Recruit.mp4"]
      }
    };

    const video = document.getElementById("player");
    const logo = document.getElementById("logo");
    const countdownBox = document.getElementById("countdown");
    const debugBox = document.getElementById("debug");

    const versione = "offline-embed";

    function getDayIndex() {
      const now = new Date();
      const hour = now.getHours();
      const min = now.getMinutes();
      const totalMin = hour * 60 + min;
      return totalMin < 300 ? (now.getDay() === 0 ? 7 : now.getDay()) - 1 : now.getDay();
    }

    function getSection(min) {
      if (min >= 1140 && min < 1260) return "Happy_Hour";
      if (min >= 1110 && min < 1140) return "Standard_1";
      if (min >= 1260 || min < 120) return "DJ";
      if (min >= 120 && min < 300) return "Standard_2";
      return "Closed";
    }

    function isCountdownTime(min, currentVideo) {
      return (min >= 1140 && min < 1260 && currentVideo === "Happy.mp4");
    }

    function updateCountdown() {
      const now = new Date();
      const target = new Date();
      target.setHours(21, 0, 0, 0);
      if (now > target) return countdownBox.style.display = "none";

      const diff = target - now;
      const h = Math.floor(diff / 3.6e6);
      const m = Math.floor((diff % 3.6e6) / 6e4);
      const s = Math.floor((diff % 6e4) / 1e3);
      countdownBox.innerText = `Match in ${h}h ${m}m ${s}s`;
    }

    let playlist = [], current = 0, countdownTimer = null;

    function playNext() {
      const now = new Date();
      const min = now.getHours() * 60 + now.getMinutes();
      const fasciaAttiva = min >= 1080 || min < 300;
      const day = getDayIndex();
      const giorno = schedule[day] || schedule["default"];
      const section = getSection(min);

      if (!fasciaAttiva || section === "Closed") {
        video.pause();
        video.style.display = "none";
        logo.style.display = "block";
        logo.src = logoUrl;
        updateDebug("Spento (05:00‚Äì18:00)", "-", versione);
        return;
      }

      playlist = giorno[section] || [];
      if (playlist.length === 0) {
        updateDebug(section, "NO VIDEO", versione);
        return;
      }

      const name = playlist[current % playlist.length];
      video.src = videoMap[name];
      video.style.display = "block";
      logo.style.display = "none";
      video.play();
      updateDebug(section, name, versione);

      if (isCountdownTime(min, name)) {
        countdownBox.style.display = "block";
        updateCountdown();
        clearInterval(countdownTimer);
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        countdownBox.style.display = "none";
        clearInterval(countdownTimer);
      }

      current++;
    }

    function updateDebug(section, videoName, ver) {
      const now = new Date();
      debugBox.innerHTML = `
        üïí ${now.toLocaleTimeString()}<br>
        üìÖ Day Index: ${getDayIndex()}<br>
        üéØ Section: ${section}<br>
        üéûÔ∏è Video: ${videoName}<br>
        ‚öôÔ∏è Version: ${ver}
      `;
    }

    video.onended = playNext;
    playNext();
  </script>
</body>
</html>
